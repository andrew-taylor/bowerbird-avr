#!/bin/bash

TEST_MODE="play"
FILE="test.wav"
FORMAT="S16_LE"
CHANNELS=`amixer -c 1 | grep 'Capture channels'|tr '-' '\n'|wc -l`
DEFAULT_ARGS="-v -Dplughw:1,0 $FILE -f $FORMAT -c $CHANNELS"

while [ "$1" ]
do
	if [ "$1" == "-x" ]
	then
		amixer -c 1 sset Mic,0 100% cap
		shift
	elif [ "$1" == "-m" ]
	then
		TEST_MODE="$2"
		shift
		shift
	elif [ "$1" == "-a" ]
	then
		PLAY_ALL=1
		shift
	else
		break
	fi
done

if [ "$TEST_MODE" != "view" ]
then
	# split recording into individual files
	DEFAULT_ARGS+=" -I"
fi

rm -f $FILE*

TEMPFILE=`tempfile`

ARECORD_CMD="arecord $DEFAULT_ARGS $@"
echo $ARECORD_CMD
if ($ARECORD_CMD > $TEMPFILE 2>&1)
then
	cat $TEMPFILE | egrep '(^[PS]| format|  rate|bits)'
	if [ "$TEST_MODE" == "view" ]
	then
		audacity $FILE
	else
		if [ "$PLAY_ALL" ]
		then
			for i in `seq 0 $(($CHANNELS-1))`
			do
				echo Channel $i
				aplay -f $FORMAT $@ $FILE.$i
			done
		else
			aplay -f $FORMAT $@ $FILE.0
		fi
	fi
else
	echo "Capture Failed:"
	cat $TEMPFILE
fi
rm -f $TEMPFILE
